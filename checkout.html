<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://checkout.flutterwave.com/v3.js"></script>
  <style>
  *{
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@500&display=swap');
    /* ----------------------------------- */
/* ðŸ“± MOBILE FIRST: max-width 640px    */
/* ----------------------------------- */
@media (max-width: 640px) {
  *{
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    @import url('https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@500&display=swap');

  /* Main grid stacks vertically */
  main {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
    padding: 1rem !important;
  }

  header h1 {
    font-size: 1.2rem !important;
  }

  header a {
    font-size: 1rem !important;
  }

  /* Billing form & order summary full width */
  .bg-white {
    width: 100% !important;
    padding: 1rem !important;
  }

  /* Inputs full width and slightly smaller text */
  input {
    width: 100% !important;
    font-size: 0.95rem !important;
  }

  /* Payment buttons stacked vertically */
  #checkoutForm .flex {
    /* flex-direction: column !important; */
    gap: 12px !important;
  }

  /* Order summary items spacing */
  #summaryList > div {
    flex-direction: column !important;
    gap: 8px !important;
  }

  /* Total text smaller */
  #checkoutTotal {
    font-size: 1.1rem !important;
  }
}

/* ----------------------------------- */
/* ðŸ“² VERY SMALL SCREEN: max-width 380px */
/* ----------------------------------- */
@media (max-width: 380px) {
  header h1 {
    font-size: 1rem !important;
  }

  header a {
    font-size: 0.9rem !important;
  }

  input {
    font-size: 0.9rem !important;
    padding: 0.5rem !important;
  }

  #checkoutForm button {
    font-size: 0.9rem !important;
    padding: 0.6rem !important;
  }

  #checkoutTotal {
    font-size: 1rem !important;
  }
}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <header class="bg-pink-100 p-4 shadow-md flex justify-between items-center">
    <button onclick="history.back()">
    <h1 class="text-xl font-bold">ðŸ§¾ Checkout</h1>
    </button>
    <a href="cart.html" class="text-pink-600 font-bold">ðŸ›’ Back to Cart</a>
  </header>

  <main class="p-6 max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">

    <!-- Billing Form -->
    <div class="bg-white p-6 shadow rounded">
      <h2 class="text-lg font-semibold mb-4">Billing Information</h2>
      <form id="checkoutForm" class="space-y-4">
        <input type="text" id="name" placeholder="Full Name" class="w-full border p-2 rounded" required />
        <input type="tel" id="phone" placeholder="Phone Number" class="w-full border p-2 rounded" required />
        <input type="email" id="email" placeholder="Email Address" class="w-full border p-2 rounded" required />
        <input type="text" id="address" placeholder="Home Address" class="w-full border p-2 rounded" required />

        <h2 class="text-lg font-semibold mb-2">Choose Payment Method</h2>
        <div class="flex gap-4">
          <button id="payWithPaystack" type="button" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">Paystack</button>
        <div class="relative group inline-block">
          <button id="payWithFlutterwave" type="button" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600  disabled:bg-gray-400 disabled:cursor-not-allowed">Flutterwave</button>
           <!-- Tooltip -->
          <span class="absolute left-1/2 -translate-x-1/2 -top-10 bg-black text-white text-sm px-4 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
          Coming Soon
          </span>
        </div>
        </div>
      </form>
    </div>

    <!-- Order Summary -->
    <div class="bg-white p-6 shadow rounded">
      <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
      <div id="summaryList" class="space-y-4"></div>
      <hr class="my-4" />
      <div class="text-right text-lg font-bold">
        Total: â‚¦<span id="checkoutTotal">0</span>
      </div>
    </div>

  </main>

  <script>
  // ===== Firebase config & init =====
  const firebaseConfig = {
    apiKey: "AIzaSyAw3H8R1hlnURjF3Nw66uLIHLRm60ZOfB0",
    authDomain: "e-commerce-project-9d5fc.firebaseapp.com",
    projectId: "e-commerce-project-9d5fc",
    storageBucket: "e-commerce-project-9d5fc.appspot.com",
    messagingSenderId: "170026324556",
    appId: "1:170026324556:web:cdae7d84eab13eecd21ae9"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let cartItems = [];

  // ===== Auth check & prefill =====
  auth.onAuthStateChanged(async user => {
    if (!user) {
      alert("Please log in to access checkout.");
      window.location.href = "login.html";
      return;
    }
    currentUser = user;

    // Prefill name/email/address
    const userDoc = await db.collection("users").doc(user.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};
    document.getElementById("name").value = userData.name || "";
    document.getElementById("email").value = userData.email || user.email || "";
    document.getElementById("address").value = userData.address || "";

    loadCart();
  });

  // ===== Load Cart =====
  async function loadCart() {
    if (!currentUser) return;
    const snapshot = await db.collection("carts").doc(currentUser.uid).collection("items").get();
    cartItems = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
    renderSummary();
  }

  function renderSummary() {
    const summaryList = document.getElementById("summaryList");
    const totalSpan = document.getElementById("checkoutTotal");

    summaryList.innerHTML = "";
    let total = 0;

    if (!cartItems.length) {
      summaryList.innerHTML = "<p class='text-gray-500'>Your cart is empty.</p>";
      totalSpan.textContent = "0";
      return;
    }

    cartItems.forEach(item => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      summaryList.innerHTML += `
        <div class="flex justify-between">
          <span>${item.name} x ${item.quantity}</span>
          <span>â‚¦${itemTotal.toLocaleString()}</span>
        </div>
      `;
    });

    totalSpan.textContent = total.toLocaleString();
  }

  // ===== Validate Billing =====
  function validateBilling() {
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    const address = document.getElementById("address").value.trim();
    if (!name || !phone || !email || !address) {
      alert("Please fill all billing fields.");
      return null;
    }
    return { name, phone, email, address };
  }

  // ===== Save Order & Clear Cart =====
  async function saveOrder(order) {
    try {
      // Add userId for Firestore rules
      const orderWithUser = { ...order, userId: currentUser.uid };

      // Save to Firestore
      await db.collection("orders").add(orderWithUser);

      // Clear cart
      const batch = db.batch();
      const cartRef = db.collection("carts").doc(currentUser.uid).collection("items");
      cartItems.forEach(item => batch.delete(cartRef.doc(item.docId)));
      await batch.commit();

      // Redirect to order-success page
      window.location.href = "order-success.html";
    } catch (err) {
      console.error("Error saving order:", err);
      alert("Something went wrong. Please contact support.");
    }
  }

  // ===== PAYSTACK =====
  document.getElementById("payWithPaystack").addEventListener("click", () => {
    const billing = validateBilling();
    if (!billing) return;
    if (!cartItems.length) { alert("Cart is empty."); return; }

    const total = cartItems.reduce((sum, i) => sum + i.price * i.quantity, 0);

    const handler = PaystackPop.setup({
      key: 'pk_test_0ed65a8011643dd303600706cb990c9ba067f199',
      email: billing.email,
      amount: total * 100,
      currency: 'NGN',
      ref: '' + Math.floor(Math.random() * 1000000000 + 1),
      metadata: { custom_fields: [
        { display_name: "Name", variable_name: "name", value: billing.name },
        { display_name: "Phone", variable_name: "phone", value: billing.phone },
        { display_name: "Address", variable_name: "address", value: billing.address }
      ]},
      callback: function(response) {
        const order = { ...billing, items: cartItems, total, paymentRef: response.reference, paymentMethod: "Paystack", timestamp: new Date(), fulfilled: false };
        saveOrder(order);
      },
      onClose: function() { alert("Payment closed."); }
    });

    handler.openIframe();
  });

  // ===== FLUTTERWAVE =====
  document.getElementById("payWithFlutterwave").addEventListener("click", () => {
  const billing = validateBilling();
  if (!billing) return;
  if (!cartItems.length) { alert("Cart is empty."); return; }

  const total = parseFloat(document.getElementById("checkoutTotal").textContent.replace(/,/g,'') || 0);
  if(total <= 0) return alert("Cart is empty.");

  const payBtn = document.getElementById("payWithFlutterwave");
  payBtn.disabled = true;
  const originalText = payBtn.textContent;
  payBtn.innerHTML = `<span class="loader inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>Processing...`;

  try {
    FlutterwaveCheckout({
      public_key: "FLWPUBK_TEST-b2421fa441f5939350f84533d0f2d3a2-X", // Replace with fresh test key
      // public_key: "", // Replace with fresh test key
      tx_ref: "TX_" + Date.now(),
      amount: total,
      currency: "NGN",
      payment_options: "card,banktransfer,ussd,mobilemoney",
      customer: {
        email: billing.email,
        name: billing.name,
        phonenumber: billing.phone
      },
      callback: function(response) {
        payBtn.disabled = false;
        payBtn.textContent = originalText;

        if (response.status === "successful") {
          const order = {
            ...billing,
            items: cartItems,
            total,
            paymentRef: response.transaction_id,
            paymentMethod: "Flutterwave",
            timestamp: new Date(),
            fulfilled: false
          };
          saveOrder(order);
        } else {
          alert("Payment failed or cancelled.");
        }
      },
      onclose: function() {
        payBtn.disabled = false;
        payBtn.textContent = originalText;
        console.log("Payment modal closed.");
      },
      customizations: { 
        title: "Pearl Skin Care", 
        description: "Secure payment for your order", 
        logo: "https://yourdomain.com/logo.png" 
      }
    });
  } catch(err) {
    payBtn.disabled = false;
    payBtn.textContent = originalText;
    console.error("Flutterwave initialization failed:", err);
    alert("Payment initialization failed. Check console for details.");
  }
});

payWithFlutterwave.disabled = true;
</script> 
</body>
</html>
