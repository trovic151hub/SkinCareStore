<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
</head>

<body class="bg-gray-100 text-gray-900">

  <!-- Modal overlay -->
<div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded shadow-lg max-w-sm w-full p-6">
    <h3 id="modalTitle" class="text-lg font-bold mb-4">Title</h3>
    <p id="modalMessage" class="mb-6">Message</p>
    <div class="flex justify-end space-x-2">
      <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 hidden">Cancel</button>
      <button id="modalOkBtn" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">OK</button>
    </div>
  </div>
</div>

  <header class="bg-pink-600 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">Admin Dashboard</h1>
    <h2 id="welcomeAdmin" class="text-xl font-bold text-white"></h2>
  </header>

  <nav class="bg-gray-200 p-4 flex gap-4 text-sm">
    <a href="index.html" class="text-pink-600 hover:underline">üè† Homepage</a>
    <a href="products.html" class="text-pink-600 hover:underline">üõç View Store</a>
    <a href="Order-History.html" class="text-pink-600 hover:underline"><i class="fas fa-clipboard text-[#4A4A4A] mr-1 text-[17px]"></i>Order History</a>
    <a href="Admin-Analytics-Summary.html" class="text-pink-600 hover:underline"><i class="fas fa-chart-pie text-[#16A] mr-1 text-[17px]"></i>Admin Analytics Summary</a>
    <button onclick="logoutAdmin()"
      class="ml-auto text-white bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</button>
  </nav>


  <main class="p-6 max-w-4xl mx-auto">

    <!-- Product Form -->
    <div class="bg-white shadow p-6 rounded mb-8">
      <h2 class="text-lg font-semibold mb-4" id="formTitle">Add New Product</h2>
      <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="name" placeholder="Product Name" class="border p-2 rounded" required />
        <input type="number" id="price" placeholder="Price (‚Ç¶)" class="border p-2 rounded" required />
        <input type="text" id="category" placeholder="Category" class="border p-2 rounded" required />
        <input type="text" id="image" placeholder="Image URL" class="border p-2 rounded" required />
        <textarea id="description" placeholder="Product Description"
          class="border p-2 rounded md:col-span-2 resize-none" rows="3"></textarea>
        <button type="submit" class="bg-pink-600 text-white px-4 py-2 rounded md:col-span-2 hover:bg-pink-700">Save
          Product</button>
      </form>
    </div>

    <!-- Product Table -->
    <div class="bg-white shadow p-6 rounded">
      <h2 class="text-lg font-semibold mb-4">Product List</h2>
      <div class="overflow-auto">
        <table class="w-full text-left border">
          <thead class="bg-pink-100">
            <tr>
              <th class="p-2">Name</th>
              <th class="p-2">Price</th>
              <th class="p-2">Category</th>
              <th class="p-2">Image</th>
              <th class="p-2">Description</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="productTableBody">

          </tbody>
        </table>
      </div>
    </div>
    <div class="text-center mt-4">
      <button id="loadMoreProductsBtn" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
        Load More Products
      </button>
    </div>
  </main>

  <!-- Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-11/12 max-w-lg p-6 rounded shadow-lg">
      <h2 class="text-xl font-bold mb-4">Order Details</h2>
      <div id="modalContent" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
      <button onclick="closeModal()"
        class="mt-4 bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">Close</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const adminFirebaseConfig = {
    apiKey: "AIzaSyAL-VE8puSjlcVwXPj_H-LBz1JXS2Iz4vc",
    authDomain: "e-commerce-admin-auth.firebaseapp.com",
    projectId: "e-commerce-admin-auth",
    storageBucket: "e-commerce-admin-auth.firebasestorage.app",
    messagingSenderId: "816965536848",
    appId: "1:816965536848:web:5ea18f3227f1ae63911555"
  };

  // Prevent duplicate initialization of Firebase Admin App
  const adminApp =
    firebase.apps.find(app => app.name === "AdminApp") ||
    firebase.initializeApp(adminFirebaseConfig, "AdminApp");

  const adminAuth = adminApp.auth();
  const db = adminApp.firestore();

  let editId = null;
  let lastVisibleProduct = null;
  const PRODUCTS_PER_PAGE = 5;

  // ===== ADMIN LOGIN & WELCOME =====
  adminAuth.onAuthStateChanged(async (user) => {
    if (!user) return goToLogin();

    try {
      const adminDoc = await db.collection("admins").doc(user.uid).get();
      if (!adminDoc.exists) {
  await showAlert("Access denied. You are not an admin.", "Access Denied");
  await adminAuth.signOut();
  return goToLogin();
}

      // Store admin login locally
      localStorage.setItem("isAdmin", "true");

      // Show welcome with first name
      const fullName = adminDoc.data().name || "Admin";
      const firstName = fullName.split(" ")[0];
      const welcomeEl = document.getElementById("welcomeAdmin");
      if (welcomeEl) welcomeEl.textContent = `Welcome, ${firstName}`;

    } catch (err) {
      console.error("Permission error:", err);
      goToLogin();
    }
  });

  function goToLogin() {
    localStorage.removeItem("isAdmin");
    window.location.href = "admin-login.html";
  }

  // ===== LOAD PRODUCTS =====
  async function loadProducts(startAfterDoc = null) {
    let query = db.collection("products").orderBy("name").limit(PRODUCTS_PER_PAGE);
    if (startAfterDoc) query = query.startAfter(startAfterDoc);

    const snap = await query.get();
    const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    lastVisibleProduct = snap.docs[snap.docs.length - 1];
    return products;
  }

  async function renderTable(append = false) {
    const tbody = document.getElementById("productTableBody");

    if (!append) tbody.innerHTML = "";
    for (let i = 0; i < PRODUCTS_PER_PAGE; i++) {
      tbody.innerHTML += `
        <tr class="border-b animate-pulse">
          <td class="p-2 bg-gray-200 rounded h-6"></td>
          <td class="p-2 bg-gray-200 rounded h-6"></td>
          <td class="p-2 bg-gray-200 rounded h-6"></td>
          <td class="p-2"><div class="w-12 h-12 bg-gray-200 rounded"></div></td>
          <td class="p-2 bg-gray-200 rounded h-6"></td>
          <td class="p-2 bg-gray-200 rounded h-6"></td>
        </tr>
      `;
    }

    const products = await loadProducts(append ? lastVisibleProduct : null);

    if (!append) tbody.innerHTML = "";
    products.forEach(p => {
      tbody.innerHTML += `
        <tr class="border-b">
          <td class="p-2">${p.name}</td>
          <td class="p-2">‚Ç¶${p.price.toLocaleString()}</td>
          <td class="p-2">${p.category}</td>
          <td class="p-2"><img src="${p.image}" alt="" class="w-12 h-12 object-cover rounded"/></td>
          <td class="p-2 text-sm max-w-xs truncate">${p.description}</td>
          <td class="p-2">
            <button onclick="editProduct('${p.id}')" class="text-blue-600 text-sm">Edit</button>
            <button onclick="deleteProduct('${p.id}')" class="text-red-600 text-sm ml-2">Delete</button>
          </td>
        </tr>
      `;
    });

    if (!append && products.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td class="p-4 text-center text-gray-500" colspan="6">No products found.</td>
        </tr>
      `;
    }

    document.getElementById("loadMoreProductsBtn").disabled = products.length < PRODUCTS_PER_PAGE;
  }

  // ===== SAVE PRODUCT =====
  document.getElementById("productForm").addEventListener("submit", async e => {
    e.preventDefault();
    const data = {
      name: document.getElementById("name").value.trim(),
      price: parseFloat(document.getElementById("price").value),
      category: document.getElementById("category").value.trim(),
      image: document.getElementById("image").value.trim(),
      description: document.getElementById("description").value.trim()
    };

    try {
      if (editId) {
        await db.collection("products").doc(editId).update(data);
        editId = null;
        document.getElementById("formTitle").textContent = "Add New Product";
      } else {
        await db.collection("products").add(data);
      }
      document.getElementById("productForm").reset();
      renderTable();
    } catch (err) {
    await showAlert("Failed to save: " + err.message, "Error");
  }
  });

  // ===== EDIT / DELETE =====
  window.editProduct = async id => {
    const doc = await db.collection("products").doc(id).get();
    const p = doc.data();
    document.getElementById("name").value = p.name;
    document.getElementById("price").value = p.price;
    document.getElementById("category").value = p.category;
    document.getElementById("image").value = p.image;
    document.getElementById("description").value = p.description;
    document.getElementById("formTitle").textContent = "Edit Product";
    editId = id;
  };

  window.deleteProduct = async id => {
  const confirmed = await showConfirm("Delete this product?");
  if (!confirmed) return;

  await db.collection("products").doc(id).delete();
  renderTable();
};

  // ===== MODAL UTILS =====
const modalOverlay = document.getElementById("modalOverlay");
const modalTitle = document.getElementById("modalTitle");
const modalMessage = document.getElementById("modalMessage");
const modalOkBtn = document.getElementById("modalOkBtn");
const modalCancelBtn = document.getElementById("modalCancelBtn");

// Show alert modal (single OK button)
function showAlert(message, title = "Alert") {
  modalTitle.textContent = title;
  modalMessage.textContent = message;
  modalCancelBtn.classList.add("hidden");
  modalOverlay.classList.remove("hidden");

  return new Promise(resolve => {
    modalOkBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      resolve(true);
    };
  });
}

// Show confirm modal (OK + Cancel)
function showConfirm(message, title = "Confirm") {
  modalTitle.textContent = title;
  modalMessage.textContent = message;
  modalCancelBtn.classList.remove("hidden");
  modalOverlay.classList.remove("hidden");

  return new Promise(resolve => {
    modalOkBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      resolve(true);
    };
    modalCancelBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      resolve(false);
    };
  });
}

  // ===== LOGOUT =====
  window.logoutAdmin = () => {
    adminAuth.signOut().then(() => {
      localStorage.removeItem("isAdmin");
      window.location.href = "admin-login.html";
    });
  };

  // ===== LOAD MORE BUTTON =====
  document.getElementById("loadMoreProductsBtn").addEventListener("click", () => {
    renderTable(true); // append = true
  });

  // INITIAL LOAD
  renderTable();
</script>
</body>
</html>
