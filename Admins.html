<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="auth-protect.js"></script>
</head>

<body class="bg-gray-100 text-gray-900">

  <header class="bg-pink-600 text-white p-4">
    <h1 class="text-xl font-bold">Admin Dashboard</h1>
  </header>

  <nav class="bg-gray-200 p-4 flex gap-4 text-sm">
    <a href="index.html" class="text-pink-600 hover:underline">üè† Homepage</a>
    <a href="products.html" class="text-pink-600 hover:underline">üõç View Store</a>
    <button onclick="logoutAdmin()"
      class="ml-auto text-white bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</button>
  </nav>


  <main class="p-6 max-w-4xl mx-auto">

    <!-- Product Form -->
    <div class="bg-white shadow p-6 rounded mb-8">
      <h2 class="text-lg font-semibold mb-4" id="formTitle">Add New Product</h2>
      <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="name" placeholder="Product Name" class="border p-2 rounded" required />
        <input type="number" id="price" placeholder="Price (‚Ç¶)" class="border p-2 rounded" required />
        <input type="text" id="category" placeholder="Category" class="border p-2 rounded" required />
        <input type="text" id="image" placeholder="Image URL" class="border p-2 rounded" required />
        <textarea id="description" placeholder="Product Description"
          class="border p-2 rounded md:col-span-2 resize-none" rows="3"></textarea>
        <button type="submit" class="bg-pink-600 text-white px-4 py-2 rounded md:col-span-2 hover:bg-pink-700">Save
          Product</button>
      </form>
    </div>

    <!-- Product Table -->
    <div class="bg-white shadow p-6 rounded">
      <h2 class="text-lg font-semibold mb-4">Product List</h2>
      <div class="overflow-auto">
        <table class="w-full text-left border">
          <thead class="bg-pink-100">
            <tr>
              <th class="p-2">Name</th>
              <th class="p-2">Price</th>
              <th class="p-2">Category</th>
              <th class="p-2">Image</th>
              <th class="p-2">Description</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="productTableBody">

          </tbody>
        </table>
      </div>
    </div>
    <div class="text-center mt-4">
      <button id="loadMoreProductsBtn" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
        Load More Products
      </button>
    </div>
  </main>

  <!-- Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-11/12 max-w-lg p-6 rounded shadow-lg">
      <h2 class="text-xl font-bold mb-4">Order Details</h2>
      <div id="modalContent" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
      <button onclick="closeModal()"
        class="mt-4 bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">Close</button>
    </div>
  </div>

  <!-- Admin Analytics Summary -->
  <div class="bg-white shadow p-6 rounded mt-10">
    <h2 class="text-lg font-semibold mb-4">üìä Analytics Summary</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
      <div>
        <p class="text-gray-500 text-sm">Total Sales</p>
        <p id="totalSales" class="text-xl font-bold text-pink-600">‚Ç¶0</p>
      </div>
      <div>
        <p class="text-gray-500 text-sm">Total Orders</p>
        <p id="totalOrders" class="text-xl font-bold text-pink-600">0</p>
      </div>
      <div>
        <p class="text-gray-500 text-sm">Top Product</p>
        <p id="topProduct" class="text-xl font-bold text-pink-600">‚Äì</p>
      </div>
    </div>
  </div>


  <section>
    <!-- Order History -->
    <div class="bg-white shadow p-6 rounded mt-10">
      <h2 class="text-lg font-semibold mb-4">Order History</h2>
      <div class="overflow-auto">
        <table class="w-full text-left border">
          <thead class="bg-pink-100">
            <tr>
              <th class="p-2">Name</th>
              <th class="p-2">Email</th>
              <th class="p-2">Phone</th>
              <th class="p-2">Total</th>
              <th class="p-2">Date</th>
            </tr>
          </thead>
          <tbody id="orderHistoryTable">

          </tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    let allProducts = [];
    let currentPage = 1;
    const productsPerPage = 5;
    let editIndex = null;
    if (localStorage.getItem("isAdmin") !== "true") {
      window.location.href = "admin-login.html";
    }

    function getData() {
      return JSON.parse(localStorage.getItem("products")) || [];
    }

    function saveData(data) {
      localStorage.setItem("products", JSON.stringify(data));
    }

    function renderTable(page = 1) {
      const tbody = document.getElementById("productTableBody");
      if (page === 1) {
        tbody.innerHTML = ""; // Only clear on first page
      }


      const start = (page - 1) * productsPerPage;
      const end = start + productsPerPage;
      const pageProducts = allProducts.slice(start, end);

      pageProducts.forEach((product, index) => {
        tbody.innerHTML += `
      <tr class="border-b">
        <td class="p-2">${product.name}</td>
        <td class="p-2">‚Ç¶${product.price.toLocaleString()}</td>
        <td class="p-2">${product.category}</td>
        <td class="p-2"><img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded" /></td>
        <td class="p-2 text-sm max-w-[200px] truncate">${product.description}</td>
        <td class="p-2 space-x-2">
          <button onclick="editProduct(${start + index})" class="text-blue-600 hover:underline text-sm">Edit</button>
          <button onclick="deleteProduct(${start + index})" class="text-red-600 hover:underline text-sm">Delete</button>
        </td>
      </tr>
    `;
      });

      const loadMoreBtn = document.getElementById("loadMoreProductsBtn");
      if (end >= allProducts.length) {
        loadMoreBtn.style.display = "none";
      } else {
        loadMoreBtn.style.display = "block";
      }
    }

    function editProduct(index) {
      const product = getData()[index];
      document.getElementById("name").value = product.name;
      document.getElementById("price").value = product.price;
      document.getElementById("category").value = product.category;
      document.getElementById("image").value = product.image;
      document.getElementById("description").value = product.description;

      document.getElementById("formTitle").textContent = "Edit Product";
      editIndex = index;
    }

    function deleteProduct(index) {
      let data = getData();
      if (confirm(`Delete ${data[index].name}?`)) {
        data.splice(index, 1);
        saveData(data);

        allProducts = getData();
        currentPage = 1;

        renderTable();

        resetForm();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      allProducts = getData();
      currentPage = 1;
      renderTable(currentPage);
      renderOrders();
    });

    document.getElementById("loadMoreProductsBtn").addEventListener("click", () => {
      currentPage++;
      renderTable(currentPage);
    });

    window.addEventListener("storage", () => {

      loadAndRenderProducts?.();
      renderHomepageProducts?.();
    });

    function renderOrders() {
      const orders = JSON.parse(localStorage.getItem("orderHistory")) || [];
      const tbody = document.getElementById("orderHistoryTable");

      if (!tbody) return;

      tbody.innerHTML = "";

      orders.forEach((order, index) => {
        const date = new Date(order.timestamp).toLocaleString();
        const fulfilledText = order.fulfilled ? "‚úÖ Fulfilled" : "‚è≥ Pending";

        tbody.innerHTML += `
    <tr class="border-b">
      <td class="p-2">${order.name}</td>
      <td class="p-2">${order.email}</td>
      <td class="p-2">${order.phone}</td>
      <td class="p-2">‚Ç¶${order.total.toLocaleString()}</td>
      <td class="p-2">${date}</td>
      <td class="p-2 space-x-2">
        <button onclick="viewOrderDetails(${index})" class="text-blue-600 hover:underline text-sm">Details</button>
        <button onclick="toggleFulfilled(${index})" class="text-green-600 hover:underline text-sm">${fulfilledText}</button>
        <button onclick="deleteOrder(${index})" class="text-red-600 hover:underline text-sm">Delete</button>
      </td>
    </tr>
  `;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderTable();
      renderOrders();
    });

    function viewOrderDetails(index) {
      const history = JSON.parse(localStorage.getItem("orderHistory")) || [];
      const order = history[index];
      const modal = document.getElementById("orderModal");
      const content = document.getElementById("modalContent");

      content.innerHTML = `
    <p><strong>Name:</strong> ${order.name}</p>
    <p><strong>Email:</strong> ${order.email}</p>
    <p><strong>Phone:</strong> ${order.phone}</p>
    <p><strong>Total:</strong> ‚Ç¶${order.total.toLocaleString()}</p>
    <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleString()}</p>
    <p><strong>Status:</strong> ${order.fulfilled ? "‚úÖ Fulfilled" : "‚è≥ Pending"}</p>
    <hr/>
    <p class="font-semibold">Items:</p>
    <ul class="list-disc pl-6">
      ${order.items.map(item => `
        <li>${item.name} √ó ${item.quantity} ‚Äî ‚Ç¶${(item.price * item.quantity).toLocaleString()}</li>
      `).join("")}
    </ul>
  `;

      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function toggleFulfilled(index) {
      const history = JSON.parse(localStorage.getItem("orderHistory")) || [];
      history[index].fulfilled = !history[index].fulfilled;
      localStorage.setItem("orderHistory", JSON.stringify(history));
      renderOrders();
    }

    function deleteOrder(index) {
      const history = JSON.parse(localStorage.getItem("orderHistory")) || [];
      if (confirm(`Delete order from ${history[index].name}?`)) {
        history.splice(index, 1);
        localStorage.setItem("orderHistory", JSON.stringify(history));
        renderOrders();
      }
    }

    function logoutAdmin() {
      localStorage.removeItem("isAdmin");
      window.location.href = "admin-login.html";
    }

    function renderAnalytics() {
      const orders = JSON.parse(localStorage.getItem("orderHistory")) || [];

      // Main summary
      const totalSales = orders.reduce((sum, order) => sum + order.total, 0);
      const totalOrders = orders.length;

      const productCount = {};
      orders.forEach(order => {
        order.items.forEach(item => {
          productCount[item.name] = (productCount[item.name] || 0) + item.quantity;
        });
      });

      let topProduct = "-";
      let maxCount = 0;
      for (const name in productCount) {
        if (productCount[name] > maxCount) {
          maxCount = productCount[name];
          topProduct = name;
        }
      }

      document.getElementById("totalSales").textContent = `‚Ç¶${totalSales.toLocaleString()}`;
      document.getElementById("totalOrders").textContent = totalOrders;
      document.getElementById("topProduct").textContent = topProduct;

      // üÜï Analytics by date
      const dailyData = {};

      orders.forEach(order => {
        const date = new Date(order.timestamp).toLocaleDateString();
        if (!dailyData[date]) {
          dailyData[date] = { total: 0, count: 0 };
        }
        dailyData[date].total += order.total;
        dailyData[date].count += 1;
      });

      const summarySection = document.querySelector("section");
      const analyticsTable = document.createElement("div");
      analyticsTable.className = "bg-white shadow p-6 rounded mt-6";

      analyticsTable.innerHTML = `
    <h2 class="text-lg font-semibold mb-4">üìÖ Sales by Date</h2>
    <div class="overflow-auto">
      <table class="w-full text-left border">
        <thead class="bg-pink-100">
          <tr>
            <th class="p-2">Date</th>
            <th class="p-2">Orders</th>
            <th class="p-2">Total Sales</th>
          </tr>
        </thead>
        <tbody>
          ${Object.entries(dailyData).map(([date, data]) => `
            <tr class="border-b">
              <td class="p-2">${date}</td>
              <td class="p-2">${data.count}</td>
              <td class="p-2">‚Ç¶${data.total.toLocaleString()}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

      summarySection.appendChild(analyticsTable);
    }

    function closeModal() {
      const modal = document.getElementById("orderModal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    document.getElementById("productForm").addEventListener("submit", function (e) {
      e.preventDefault();

      const name = document.getElementById("name").value.trim();
      const price = parseFloat(document.getElementById("price").value);
      const category = document.getElementById("category").value.trim();
      const image = document.getElementById("image").value.trim();
      const description = document.getElementById("description").value.trim();

      let products = getData();

      const newProduct = { name, price, category, image, description };

      if (editIndex !== null) {
      
        products[editIndex] = newProduct;
        editIndex = null;
        document.getElementById("formTitle").textContent = "Add New Product";
      } else {
      
        products.push(newProduct);
      }

      saveData(products);
      document.getElementById("productForm").reset();
      document.getElementById("productTableBody").innerHTML = "";
      allProducts = getData();
      currentPage = 1;
      renderTable(currentPage);
    });

    renderAnalytics();
  </script>
</body>

</html>