<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">

  <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center text-pink-600">Admin Login</h2>
    <form id="adminLoginForm" class="space-y-4">
      <input type="email" id="adminEmail" placeholder="Email" class="w-full border p-2 rounded" required />

      <div class="relative">
        <input type="password" id="adminPassword" placeholder="Password" class="w-full border p-2 rounded" required />
        <i id="toggleAdminPassword" class="fa fa-eye absolute right-3 top-3 text-gray-500 cursor-pointer"></i>
      </div>

      <button id="loginBtn" type="submit" class="w-full bg-pink-600 text-white py-2 rounded hover:bg-pink-700 flex items-center justify-center gap-2">
        <span id="loginBtnText">Login</span>
        <span id="loginSpinner" class="hidden">
          <i class="fa-solid fa-circle-notch fa-spin"></i>
        </span>
      </button>

      <p id="loginError" class="text-red-500 text-sm hidden mt-2"></p>

      <p class="mt-4 text-center text-sm">
        Not an Admin? <a href="admin-register.html" class="text-pink-600">Register</a>
      </p>
    </form>
  </div>

  <!-- Modal -->
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded shadow-lg max-w-sm w-full p-6">
      <h3 id="modalTitle" class="text-lg font-bold mb-4">Title</h3>
      <p id="modalMessage" class="mb-6">Message</p>
      <div class="flex justify-end space-x-2">
        <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 hidden">Cancel</button>
        <button id="modalOkBtn" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">OK</button>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  const adminFirebaseConfig = {
    apiKey: "AIzaSyAL-VE8puSjlcVwXPj_H-LBz1JXS2Iz4vc",
    authDomain: "e-commerce-admin-auth.firebaseapp.com",
    projectId: "e-commerce-admin-auth",
    storageBucket: "e-commerce-admin-auth.firebasestorage.app",
    messagingSenderId: "816965536848",
    appId: "1:816965536848:web:5ea18f3227f1ae63911555"
  };

  const adminApp = firebase.apps.find(app => app.name === "AdminApp") || firebase.initializeApp(adminFirebaseConfig, "AdminApp");
  const adminAuth = adminApp.auth();
  const db = adminApp.firestore();

  const form = document.getElementById("adminLoginForm");
  const loginError = document.getElementById("loginError");
  const loginBtn = document.getElementById("loginBtn");
  const loginBtnText = document.getElementById("loginBtnText");
  const loginSpinner = document.getElementById("loginSpinner");

  const toggleAdminPassword = document.getElementById("toggleAdminPassword");
  const adminPassword = document.getElementById("adminPassword");
  toggleAdminPassword.addEventListener("click", () => {
    if (adminPassword.type === "password") {
      adminPassword.type = "text";
      toggleAdminPassword.classList.replace("fa-eye", "fa-eye-slash");
    } else {
      adminPassword.type = "password";
      toggleAdminPassword.classList.replace("fa-eye-slash", "fa-eye");
    }
  });

  // ===== MODAL UTILS =====
  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalMessage = document.getElementById("modalMessage");
  const modalOkBtn = document.getElementById("modalOkBtn");
  const modalCancelBtn = document.getElementById("modalCancelBtn");

  function showAlert(message, title="Alert") {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalCancelBtn.classList.add("hidden");
    modalOverlay.classList.remove("hidden");
    return new Promise(resolve => {
      modalOkBtn.onclick = () => {
        modalOverlay.classList.add("hidden");
        resolve(true);
      };
    });
  }

  form.addEventListener("submit", async e => {
    e.preventDefault();
    loginError.classList.add("hidden");

    loginBtn.disabled = true;
    loginBtn.classList.add("opacity-50", "cursor-not-allowed");
    loginBtnText.textContent = "Logging in...";
    loginSpinner.classList.remove("hidden");

    const email = document.getElementById("adminEmail").value.trim();
    const password = adminPassword.value;

    try {
      await adminAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); // Keep login persistent
      const userCredential = await adminAuth.signInWithEmailAndPassword(email, password);
      const user = userCredential.user;

      const adminDoc = await db.collection("admins").doc(user.uid).get();
      if (!adminDoc.exists) {
        await showAlert("You are not authorized as admin.", "Access Denied");
        await adminAuth.signOut();
        loginBtn.disabled = false;
        loginBtn.classList.remove("opacity-50", "cursor-not-allowed");
        loginBtnText.textContent = "Login";
        loginSpinner.classList.add("hidden");
        return;
      }

      await db.collection("admins").doc(user.uid).update({
        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
      });

      window.location.href = "Admins.html"; // Redirect to dashboard

    } catch(err) {
      loginError.textContent = err.message;
      loginError.classList.remove("hidden");
      loginBtn.disabled = false;
      loginBtn.classList.remove("opacity-50", "cursor-not-allowed");
      loginBtnText.textContent = "Login";
      loginSpinner.classList.add("hidden");
    }
  });

</script>
</body>
</html>
