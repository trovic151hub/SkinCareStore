<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Order History — Advanced</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat (works like your other pages) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @keyframes slide-in { 0%{transform:translateY(-20px);opacity:0}100%{transform:none;opacity:1} }
    .animate-slide-in { animation: slide-in .22s ease-out; }
    .timeline-step { width: 10px; height: 10px; border-radius: 999px; display:inline-block; margin-right:8px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <header class="bg-pink-600 text-white p-4">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <div class="flex space-x-2">
        <button onclick="history.back()">
      <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-lg font-bold">Order History — Advanced</h1>
      </div>
      <div id="adminBadge" class="hidden bg-white text-pink-600 px-2 py-1 rounded text-sm">ADMIN</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6">

    <!-- FILTERS / SEARCH -->
    <section class="bg-white p-4 rounded shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input id="qText" placeholder="Search product / name / paymentRef" class="border p-2 rounded" />
        <select id="filterStatus" class="border p-2 rounded">
          <option value="all">All status</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
        </select>
        <select id="filterShipment" class="border p-2 rounded">
          <option value="all">All shipment</option>
          <option value="processing">Processing</option>
          <option value="shipped">Shipped</option>
          <option value="delivered">Delivered</option>
        </select>
        <select id="filterPayment" class="border p-2 rounded">
          <option value="all">All payment</option>
          <option value="Paystack">Paystack</option>
          <option value="Flutterwave">Flutterwave</option>
          <option value="Cash">Cash</option>
        </select>
      </div>

      <div class="flex gap-3 mt-3">
        <input id="dateFrom" type="date" class="border p-2 rounded" />
        <input id="dateTo" type="date" class="border p-2 rounded" />
        <button id="applyFilters" class="bg-pink-600 text-white px-4 py-2 rounded">Apply</button>
        <button id="clearFilters" class="bg-gray-200 px-4 py-2 rounded">Clear</button>
        <div class="ml-auto flex gap-2">
          <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Refresh</button>
        </div>
      </div>
    </section>

    <!-- ORDERS TABLE -->
    <section class="bg-white p-4 rounded shadow">
      <div class="overflow-auto">
        <table class="w-full text-left">
          <thead class="bg-pink-100">
            <tr>
              <th class="p-2">When</th>
              <th class="p-2">Customer</th>
              <th class="p-2">Total</th>
              <th class="p-2">Payment</th>
              <th class="p-2">Shipment</th>
              <th class="p-2">Status</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTbody">
            <!-- skeleton or rows -->
          </tbody>
        </table>
      </div>

      <div class="flex justify-center mt-4">
        <button id="loadMoreBtn" class="bg-pink-500 text-white px-4 py-2 rounded">Load more</button>
      </div>
    </section>
  </main>

  <!-- DETAIL MODAL -->
  <div id="detailModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-2xl p-6 rounded shadow-lg animate-slide-in max-h-[90vh] overflow-auto">
      <div class="flex justify-between items-start gap-4">
        <h2 class="text-2xl font-semibold text-pink-600">Order Details</h2>
        <div>
          <button id="modalClose" class="text-gray-600 hover:text-gray-800 text-xl">&times;</button>
        </div>
      </div>

      <div id="detailContent" class="mt-4 space-y-3 text-sm text-gray-800"></div>

      <div class="mt-4 flex gap-2">
        <button id="downloadPdfBtn" class="bg-pink-600 text-white px-4 py-2 rounded">Download PDF</button>
        <button id="emailReceiptBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Email Receipt</button>
        <div id="modalStatusControls" class="ml-auto flex gap-2">
          <!-- Admin controls: mark shipment / delete -->
        </div>
      </div>
    </div>
  </div>

  <div id="modalStatusControls" class="mt-4 flex items-center"></div>

  <script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyAw3H8R1hlnURjF3Nw66uLIHLRm60ZOfB0",
    authDomain: "e-commerce-project-9d5fc.firebaseapp.com",
    projectId: "e-commerce-project-9d5fc",
    storageBucket: "e-commerce-project-9d5fc.appspot.com",
    messagingSenderId: "170026324556",
    appId: "1:170026324556:web:cdae7d84eab13eecd21ae9"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ADMIN KEY
  const ADMIN_KEY = "YOUR_SECRET_KEY_HERE";

  // STATE
  let PAGE_SIZE = 6;
  let lastDoc = null;
  let loadingMore = false;
  let activeFilters = {};
  let currentOpenOrder = null;
  let isAdmin = true; // for modal controls

  // UI refs
  const ordersTbody = document.getElementById('ordersTbody');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const modalStatusControls = document.getElementById('modalStatusControls');
  const detailModal = document.getElementById('detailModal');
  const detailContent = document.getElementById('detailContent');
  const modalClose = document.getElementById('modalClose');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const emailReceiptBtn = document.getElementById('emailReceiptBtn');

  // ALERT MODAL
  const alertModal = document.createElement('div');
  alertModal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50';
  alertModal.innerHTML = `
    <div class="bg-white p-6 rounded shadow-lg w-80 text-center">
      <div id="alertMessage" class="mb-4"></div>
      <button id="alertOkBtn" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
    </div>`;
  document.body.appendChild(alertModal);
  const alertMessage = alertModal.querySelector('#alertMessage');
  const alertOkBtn = alertModal.querySelector('#alertOkBtn');
  alertOkBtn.addEventListener('click', ()=>alertModal.classList.add('hidden'));
  function showAlert(msg, type='Info') {
    alertMessage.innerHTML = `<strong>${type}:</strong> ${msg}`;
    alertModal.classList.remove('hidden');
  }

  // CONFIRM MODAL
  const confirmModal = document.createElement('div');
  confirmModal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50';
  confirmModal.innerHTML = `
    <div class="bg-white p-6 rounded shadow-lg w-80 text-center">
      <div id="confirmMessage" class="mb-4"></div>
      <div class="flex justify-around">
        <button id="confirmYesBtn" class="bg-green-600 text-white px-4 py-2 rounded">Yes</button>
        <button id="confirmNoBtn" class="bg-red-600 text-white px-4 py-2 rounded">No</button>
      </div>
    </div>`;
  document.body.appendChild(confirmModal);
  const confirmMessage = confirmModal.querySelector('#confirmMessage');
  const confirmYesBtn = confirmModal.querySelector('#confirmYesBtn');
  const confirmNoBtn = confirmModal.querySelector('#confirmNoBtn');
  function showConfirm(msg) {
    return new Promise(resolve => {
      confirmMessage.innerText = msg;
      confirmModal.classList.remove('hidden');
      confirmYesBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(true); };
      confirmNoBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(false); };
    });
  }

  // FILTER elements
  const qText = document.getElementById('qText');
  const filterStatus = document.getElementById('filterStatus');
  const filterShipment = document.getElementById('filterShipment');
  const filterPayment = document.getElementById('filterPayment');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');

  // ========== UTILITY ==========
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function shipmentTimelineHtml(status) {
    const steps = ['processing','shipped','delivered'];
    return `<div class="flex items-center gap-4">
      ${steps.map((s, idx) => {
        const done = steps.indexOf(status) >= idx;
        return `<div class="flex items-center gap-3">
          <span class="timeline-step ${done ? 'bg-green-600' : 'bg-gray-300'}"></span>
          <div class="${done ? 'text-green-700 font-semibold' : 'text-gray-600'} text-sm">${capitalize(s)}</div>
        </div>`; 
      }).join('<span class="text-gray-300">→</span>')}
    </div>`;
  }

  // ========== QUERY / LOAD ==========
  function buildBaseQuery(pageSize = PAGE_SIZE, startAfterDoc = null) {
    let q = db.collection('orders').orderBy('timestamp', 'desc');

    if (activeFilters.status && activeFilters.status !== 'all') {
      const fulfilled = activeFilters.status === 'completed';
      q = q.where('fulfilled', '==', fulfilled);
    }

    if (activeFilters.payment && activeFilters.payment !== 'all') {
      q = q.where('paymentMethod', '==', activeFilters.payment);
    }

    if (activeFilters.shipment && activeFilters.shipment !== 'all') {
      q = q.where('shipmentStatus', '==', activeFilters.shipment);
    }

    if (activeFilters.from) {
      const fromDateObj = new Date(activeFilters.from + 'T00:00:00');
      q = q.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(fromDateObj));
    }
    if (activeFilters.to) {
      const toDateObj = new Date(activeFilters.to + 'T23:59:59');
      q = q.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(toDateObj));
    }

    q = q.limit(pageSize);
    if (startAfterDoc) q = q.startAfter(startAfterDoc);
    return q;
  }

  async function clearAndLoad() {
    ordersTbody.innerHTML = '';
    lastDoc = null;
    await loadMore(true);
  }

  async function loadMore(isInitial=false) {
    loadingMore = true;
    loadMoreBtn.disabled = true;

    // skeleton
    for (let i = 0; i < 3; i++) {
      const r = document.createElement('tr');
      r.innerHTML = `<td class="p-2 bg-gray-200 animate-pulse"></td>`.repeat(7);
      ordersTbody.appendChild(r);
    }

    try {
      const snap = await buildBaseQuery(PAGE_SIZE, lastDoc).get();
      ordersTbody.innerHTML = '';

      if (snap.empty && !lastDoc) {
        ordersTbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-gray-500">No orders found.</td></tr>`;
        loadMoreBtn.style.display = 'none';
        return;
      }

      const docs = snap.docs.map(d => ({id: d.id, ...d.data()}));

      const filteredDocs = activeFilters.q ? docs.filter(o => {
        const qlow = activeFilters.q.toLowerCase();
        return (o.name && o.name.toLowerCase().includes(qlow)) ||
               (o.paymentRef && o.paymentRef.toLowerCase().includes(qlow)) ||
               (Array.isArray(o.items) && o.items.some(it => (it.name||'').toLowerCase().includes(qlow)));
      }) : docs;

      filteredDocs.forEach(order => ordersTbody.appendChild(orderRow(order)));

      lastDoc = snap.docs[snap.docs.length-1] || lastDoc;
      loadMoreBtn.style.display = snap.size < PAGE_SIZE ? 'none' : 'inline-block';
    } catch (err) {
      console.error('Error loading orders:', err);
      ordersTbody.innerHTML = `<tr><td colspan="7" class="p-4 text-red-500">Failed to load orders.</td></tr>`;
    } finally {
      loadingMore = false;
      loadMoreBtn.disabled = false;
    }
  }

  // ========== RENDER ROW ==========
  function orderRow(order) {
    const tr = document.createElement('tr');
    const when = order.timestamp && order.timestamp.toDate ? order.timestamp.toDate().toLocaleString() : new Date(order.timestamp||'').toLocaleString();
    tr.id = `order-${order.id}`;

    tr.innerHTML = `
      <td class="p-2 align-top">${when}</td>
      <td class="p-2 align-top">${order.name||''}</td>
      <td class="p-2 align-top">₦${Number(order.total||0).toLocaleString()}</td>
      <td class="p-2 align-top">${order.paymentMethod||''}</td>
      <td class="p-2 align-top">${order.shipmentStatus || 'processing'}</td>
      <td class="p-2 align-top">
        <span class="px-2 py-1 rounded text-xs ${order.fulfilled ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
          ${order.fulfilled ? 'Completed' : 'Pending'}
        </span>
      </td>
      <td class="p-2 align-top">
        <div class="flex flex-col md:flex-row gap-2">
          <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick='openDetail("${order.id}")'>Detail</button>
          <button class="bg-pink-500 text-white px-3 py-1 rounded" onclick='toggleFulfilled("${order.id}", ${!!order.fulfilled})'>${order.fulfilled ? 'Mark Pending' : 'Mark Complete'}</button>
          <button class="bg-red-500 text-white px-3 py-1 rounded opacity-50 cursor-not-allowed" onclick='deleteOrder("${order.id}")' disabled>Delete</button>
        </div>
      </td>
    `;
    tr.__order = order;
    return tr;
  }

  // ========== GLOBAL FUNCTIONS ==========
  window.toggleFulfilled = async function(orderId, currentStatus) {
    try {
      await db.collection('orders').doc(orderId).update({fulfilled: !currentStatus, adminKey: ADMIN_KEY});
      const row = document.getElementById('order-'+orderId);
      if (row && row.__order) {
        row.__order.fulfilled = !currentStatus;
        row.replaceWith(orderRow(row.__order));
      } else {
        clearAndLoad();
      }
      if (currentOpenOrder && currentOpenOrder.id === orderId) {
        currentOpenOrder.fulfilled = !currentStatus;
        renderModal(currentOpenOrder);
      }
    } catch(err) {
      showAlert('Failed to change status: '+(err.message||err), 'Error');
    }
  }

  window.updateShipmentStatus = async function(orderId, shipmentStatus) {
    try {
      await db.collection('orders').doc(orderId).update({shipmentStatus, adminKey: ADMIN_KEY});
      if (currentOpenOrder && currentOpenOrder.id === orderId) {
        currentOpenOrder.shipmentStatus = shipmentStatus;
        renderModal(currentOpenOrder);
      }
      const rowEl = document.getElementById('order-'+orderId);
      if (rowEl && rowEl.__order) {
        rowEl.__order.shipmentStatus = shipmentStatus;
        rowEl.replaceWith(orderRow(rowEl.__order));
      }
    } catch(err) { showAlert('Failed to update shipment: '+err.message, 'Error'); }
  }

  window.openDetail = async function(orderId) {
    try {
      const doc = await db.collection('orders').doc(orderId).get();
      if (!doc.exists) { showAlert('Order not found', 'Error'); return; }
      currentOpenOrder = {id: doc.id, ...doc.data()};
      renderModal(currentOpenOrder);
    } catch(err) { console.error('openDetail error', err); }
  }

  function renderModal(order) {
    detailContent.innerHTML = '';
    const headerHtml = `
      <div class="flex justify-between items-center">
        <div>
          <div class="text-lg font-semibold">${escapeHtml(order.name||'')}</div>
          <div class="text-xs text-gray-600">${escapeHtml(order.email||'')} • ${escapeHtml(order.phone||'')}</div>
          <div class="text-xs text-gray-600 mt-1">Ref: ${escapeHtml(order.paymentRef||'')}</div>
        </div>
        <div class="text-right">
          <div class="text-sm">Total</div>
          <div class="text-xl font-bold">₦${Number(order.total||0).toLocaleString()}</div>
        </div>
      </div>
    `;

    const itemsHtml = (order.items || []).map(i => `
      <div class="flex justify-between border-b py-2">
        <div>
          <div class="font-medium">${escapeHtml(i.name)}</div>
          <div class="text-xs text-gray-600">₦${Number(i.price).toLocaleString()} each</div>
        </div>
        <div class="text-right">
          <div>${i.quantity} ×</div>
          <div class="font-semibold">₦${(i.price * i.quantity).toLocaleString()}</div>
        </div>
      </div>
    `).join('');

    const prog = shipmentTimelineHtml(order.shipmentStatus || 'processing');

    const bodyHtml = `
      <div class="mt-3">${headerHtml}</div>

      <div class="mt-4">
        <h4 class="font-semibold">Items</h4>
        <div class="mt-2">${itemsHtml || '<div class="text-gray-500">No items listed</div>'}</div>
      </div>

      <div class="mt-4">
        <h4 class="font-semibold">Delivery</h4>
        <p class="text-sm text-gray-600">${escapeHtml(order.address||'—')}</p>
        <div class="mt-2">${prog}</div>
      </div>

      <div class="mt-4">
        <h4 class="font-semibold">Payment</h4>
        <p class="text-sm text-gray-600">${escapeHtml(order.paymentMethod||'')}</p>
        <p class="text-sm text-gray-600">Ref: ${escapeHtml(order.paymentRef||'')}</p>
      </div>
    `;

    detailContent.innerHTML = bodyHtml;
    detailModal.classList.remove('hidden');
    detailModal.classList.add('flex');

    downloadPdfBtn.onclick = () => downloadPdf(order);
    emailReceiptBtn.onclick = () => triggerEmailReceipt(order);

    // ADMIN CONTROLS
    modalStatusControls.innerHTML = '';

    if (isAdmin) {
      const sel = document.createElement('select');
      sel.className = 'border p-2 rounded';
      sel.innerHTML =
        `<option value="processing">Processing</option>
         <option value="shipped">Shipped</option>
         <option value="delivered">Delivered</option>`;
      sel.value = order.shipmentStatus || 'processing';

      sel.onchange = () => updateShipmentStatus(order.id, sel.value);

      modalStatusControls.appendChild(sel);

      const delBtn = document.createElement('button');
      delBtn.className = 'ml-2 bg-red-600 text-white px-3 py-2 rounded opacity-50 cursor-not-allowed';
      delBtn.innerText = 'Delete Order';
      // delBtn.onclick = () => deleteOrder(order.id);
      delBtn.disabled = true;

      modalStatusControls.appendChild(delBtn);
    }
  }

  modalClose.addEventListener('click', () => {
    detailModal.classList.add('hidden');
    currentOpenOrder = null;
  });

  // ========== DELETE ORDER ==========
  async function deleteOrder(orderId){
    const ok = await showConfirm('Are you sure you want to delete this order?');
    if(!ok) return;
    try{
      await db.collection('orders').doc(orderId).delete();
      document.getElementById('order-'+orderId)?.remove();
      showAlert('Order deleted successfully!', 'Success');
      if(currentOpenOrder && currentOpenOrder.id===orderId){
        detailModal.classList.add('hidden');
        currentOpenOrder=null;
      }
    }catch(err){
      showAlert('Delete error: '+(err.message||err), 'Error');
    }
  }

  // ========== PROFESSIONAL PDF WITH LOGO + POLISHED TABLE + FOOTER LINE ==========
async function downloadPdf(order) {
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const dark = "#222222";
    const gray = "#555555";
    const gold = "#d4a017";
    const rowLight = "#f7f7f7"; // alternating row color

    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    let y = 20;

    // ====== FETCH LOGO FROM CLOUDINARY AND CONVERT TO BASE64 ======
    const logoURL = "https://res.cloudinary.com/dut2dpxuc/image/upload/v1764188839/e1232d47-ee66-47c9-97fa-b9b86232fb80_n35lqo.png";
    const response = await fetch(logoURL);
    const blob = await response.blob();
    const base64Logo = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });

    // ===== ADD LOGO =====
    const logoWidth = 50;
    const logoHeight = 25;
    const logoX = (pageWidth - logoWidth) / 2;
    doc.addImage(base64Logo, "PNG", logoX, 10, logoWidth, logoHeight);
    y = 45;

    // ===== ORDER RECEIPT TITLE (LEFT-ALIGNED) =====
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(dark);
    doc.text("ORDER RECEIPT", margin, y);
    y += 15;

    // ===== HORIZONTAL LINE =====
    doc.setDrawColor("#e0e0e0");
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 5;

    // ===== CUSTOMER INFO CARD =====
    doc.setFillColor("#f9f9f9");
    doc.roundedRect(margin, y, pageWidth - margin * 2, 40, 3, 3, "F");
    doc.setFontSize(12);
    doc.setTextColor(dark);

    y += 10;
    doc.text(`Name: ${order.name || ""}`, margin + 5, y);
    y += 7;
    doc.text(`Email: ${order.email || ""}`, margin + 5, y);
    y += 7;
    doc.text(`Phone: ${order.phone || ""}`, margin + 5, y);
    y += 7;
    doc.text(`Payment Ref: ${order.paymentRef || ""}`, margin + 5, y);

    y += 15;

    // ===== HORIZONTAL LINE =====
    doc.setDrawColor("#e0e0e0");
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 5;

    // ===== TABLE HEADER =====
    doc.setFillColor(gold);
    doc.setTextColor("#ffffff");
    doc.setFontSize(11);
    const tableX = margin;
    const tableWidth = pageWidth - margin * 2;
    const rowHeight = 8;

    // Draw header background
    doc.rect(tableX, y, tableWidth, rowHeight, "F");

    // Header text
    doc.text("Item", tableX + 2, y + 6);
    doc.text("Qty", tableX + 80, y + 6);
    doc.text("Price", tableX + 110, y + 6, { align: "right" });
    doc.text("Total", tableX + 150, y + 6, { align: "right" });

    y += rowHeight;

    // ===== ITEM ROWS =====
    const items = order.items || [];
    doc.setTextColor("#000000");

    items.forEach((i, index) => {
      if (y > 260) {
        doc.addPage();
        y = 20;
      }

      // alternating row color
      if (index % 2 === 0) {
        doc.setFillColor(rowLight);
        doc.rect(tableX, y, tableWidth, rowHeight, "F");
      }

      // item details
      doc.text(i.name || "", tableX + 2, y + 6);
      doc.text(`${i.quantity}`, tableX + 80, y + 6);
      doc.text(`₦${Number(i.price).toLocaleString()}`, tableX + 110, y + 6, { align: "right" });
      doc.text(`₦${(i.price * i.quantity).toLocaleString()}`, tableX + 150, y + 6, { align: "right" });

      // row border
      doc.setDrawColor("#e0e0e0");
      doc.rect(tableX, y, tableWidth, rowHeight);

      y += rowHeight;
    });

    // ===== ORDER TOTAL ROW (INSIDE TABLE) =====
    doc.setFillColor("#eaeaea");
    doc.rect(tableX, y, tableWidth, rowHeight, "F");

    doc.setFont("helvetica", "bold");
    doc.text("Order Total", tableX + 110, y + 6, { align: "right" });
    doc.text(`₦${Number(order.total || 0).toLocaleString()}`, tableX + 150, y + 6, { align: "right" });

    // bottom border
    doc.setDrawColor("#e0e0e0");
    doc.rect(tableX, y, tableWidth, rowHeight);

    y += rowHeight + 5;

    // ===== ADDRESS =====
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    doc.setTextColor(gray);
    doc.text("Delivery Address:", margin, y);
    y += 6;
    const addressLines = doc.splitTextToSize(order.address || "—", pageWidth - margin * 2);
    doc.text(addressLines, margin, y);

    // ===== FOOTER =====
    y = 285;
    doc.setFontSize(10);
    doc.setTextColor(gray);
    doc.text(
      "Thank you for shopping with Pearl Skin Care!",
      pageWidth / 2,
      y,
      { align: "center" }
    );

    // ===== SAVE PDF =====
    doc.save(`Order_${order.paymentRef || order.id}.pdf`);
    showAlert("PDF generated successfully!", "Success");

  } catch (err) {
    showAlert("Failed to generate PDF: " + (err.message || err), "Error");
  }
}

  // ========== EVENT LISTENERS ==========
  document.getElementById('applyFilters').addEventListener('click', ()=>{ 
    activeFilters = {
      status: filterStatus.value,
      shipment: filterShipment.value,
      payment: filterPayment.value,
      q: qText.value.trim(),
      from: dateFrom.value,
      to: dateTo.value
    };
    clearAndLoad();
  });

  document.getElementById('clearFilters').addEventListener('click', ()=>{
    filterStatus.value='all'; filterShipment.value='all'; filterPayment.value='all'; qText.value=''; dateFrom.value=''; dateTo.value='';
    activeFilters = {};
    clearAndLoad();
  });

  document.getElementById('refreshBtn').addEventListener('click', ()=>clearAndLoad());
  loadMoreBtn.addEventListener('click', ()=>{ if(!loadingMore) loadMore(); });

  emailReceiptBtn.disabled = true;
  emailReceiptBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

  // ========== INIT ==========
  clearAndLoad();

  function escapeHtml(text){ return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
